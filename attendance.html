<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì¶œì„ ì²´í¬</title>
    <meta name="description" content="í•™ìƒ ì¶œì„ì„ ê´€ë¦¬í•˜ëŠ” ì•±">
    <meta name="theme-color" content="#3B82F6">
    <link rel="manifest" href="data:application/json;charset=utf-8,{%22name%22:%22ì¶œì„%20ì²´í¬%20ì•±%22,%22short_name%22:%22ì¶œì„ì²´í¬%22,%22description%22:%22í•™ìƒ%20ì¶œì„ì„%20ê´€ë¦¬í•˜ëŠ”%20ì•±%22,%22start_url%22:%22/%22,%22display%22:%22standalone%22,%22background_color%22:%22%23DBEAFE%22,%22theme_color%22:%22%233B82F6%22,%22icons%22:[{%22src%22:%22https://cdn-icons-png.flaticon.com/512/3135/3135715.png%22,%22sizes%22:%22192x192%22,%22type%22:%22image/png%22},{%22src%22:%22https://cdn-icons-png.flaticon.com/512/3135/3135715.png%22,%22sizes%22:%22512x512%22,%22type%22:%22image/png%22}]}">
    <link rel="icon" href="https://cdn-icons-png.flaticon.com/512/3135/3135715.png">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/3135/3135715.png">
    
    <!-- iOS ë©”íƒ€ íƒœê·¸ -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="ì¶œì„ì²´í¬">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.development.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        /* PWA ì„¤ì¹˜ í”„ë¡¬í”„íŠ¸ ìŠ¤íƒ€ì¼ */
        .install-prompt {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: #3B82F6;
            color: white;
            padding: 12px 24px;
            border-radius: 25px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000;
            display: none;
            animation: slideUp 0.3s ease-out;
        }
        
        @keyframes slideUp {
            from { transform: translate(-50%, 100px); opacity: 0; }
            to { transform: translate(-50%, 0); opacity: 1; }
        }
        
        /* ì˜¤í”„ë¼ì¸ í‘œì‹œ */
        .offline-indicator {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: #EF4444;
            color: white;
            text-align: center;
            padding: 8px;
            z-index: 1000;
            display: none;
        }
        
        /* ë°˜ì‘í˜• ê°œì„  */
        @media (max-width: 640px) {
            .student-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }
        
        @media (min-width: 641px) and (max-width: 768px) {
            .student-grid {
                grid-template-columns: repeat(4, 1fr);
            }
        }
        
        @media (min-width: 769px) {
            .student-grid {
                grid-template-columns: repeat(6, 1fr);
            }
        }
    </style>
</head>
<body>
    <!-- ì˜¤í”„ë¼ì¸ í‘œì‹œ -->
    <div id="offline-indicator" class="offline-indicator">
        ğŸ“¡ ì˜¤í”„ë¼ì¸ ëª¨ë“œì…ë‹ˆë‹¤
    </div>
    
    <!-- PWA ì„¤ì¹˜ í”„ë¡¬í”„íŠ¸ -->
    <div id="install-prompt" class="install-prompt">
        <span>ğŸ“± í™ˆ í™”ë©´ì— ì¶”ê°€í•˜ì‹œê² ìŠµë‹ˆê¹Œ?</span>
        <button id="install-btn" class="ml-3 bg-white text-blue-600 px-3 py-1 rounded-full text-sm font-semibold">ì„¤ì¹˜</button>
        <button id="dismiss-btn" class="ml-2 text-blue-200 text-sm">ë‚˜ì¤‘ì—</button>
    </div>

    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;
        const { Check, X, Clock, Wifi, WifiOff } = lucide;

        const AttendanceChecker = () => {
            // í•™ìƒ ë²ˆí˜¸ ë°°ì—´ ìƒì„± (1-8, 10-25)
            const studentNumbers = [
                ...Array.from({length: 8}, (_, i) => i + 1),
                ...Array.from({length: 16}, (_, i) => i + 10)
            ];

            // localStorageì—ì„œ ë°ì´í„° ë¡œë“œ (PWAì—ì„œëŠ” ë©”ëª¨ë¦¬ ì €ì¥ì†Œ ì‚¬ìš©)
            const loadFromStorage = (key, defaultValue) => {
                try {
                    const saved = window.attendanceData?.[key];
                    return saved ? JSON.parse(saved) : defaultValue;
                } catch {
                    return defaultValue;
                }
            };

            const saveToStorage = (key, value) => {
                try {
                    if (!window.attendanceData) window.attendanceData = {};
                    window.attendanceData[key] = JSON.stringify(value);
                } catch (e) {
                    console.log('ì €ì¥ ì‹¤íŒ¨:', e);
                }
            };

            // ì¶œì„ ìƒíƒœ ì´ˆê¸°í™”
            const initializeAttendance = () => {
                const initial = {};
                studentNumbers.forEach(num => {
                    initial[num] = 'unchecked';
                });
                return initial;
            };

            const [attendance, setAttendance] = useState(() => 
                loadFromStorage('attendance', initializeAttendance())
            );
            
            const [lateTime, setLateTime] = useState(() => 
                loadFromStorage('lateTime', {})
            );
            
            const [showTimeModal, setShowTimeModal] = useState(false);
            const [selectedStudent, setSelectedStudent] = useState(null);
            const [currentDate] = useState(new Date().toLocaleDateString('ko-KR'));
            const [isOnline, setIsOnline] = useState(navigator.onLine);

            // ì˜¨ë¼ì¸/ì˜¤í”„ë¼ì¸ ìƒíƒœ ê°ì§€
            useEffect(() => {
                const handleOnline = () => {
                    setIsOnline(true);
                    document.getElementById('offline-indicator').style.display = 'none';
                };
                
                const handleOffline = () => {
                    setIsOnline(false);
                    document.getElementById('offline-indicator').style.display = 'block';
                };

                window.addEventListener('online', handleOnline);
                window.addEventListener('offline', handleOffline);

                // ì´ˆê¸° ìƒíƒœ ì„¤ì •
                if (!navigator.onLine) {
                    handleOffline();
                }

                return () => {
                    window.removeEventListener('online', handleOnline);
                    window.removeEventListener('offline', handleOffline);
                };
            }, []);

            // ë°ì´í„° ì €ì¥
            useEffect(() => {
                saveToStorage('attendance', attendance);
            }, [attendance]);

            useEffect(() => {
                saveToStorage('lateTime', lateTime);
            }, [lateTime]);

            const toggleAttendance = (studentNum) => {
                setAttendance(prev => {
                    const current = prev[studentNum];
                    let next;
                    
                    switch(current) {
                        case 'unchecked': next = 'present'; break;
                        case 'present': 
                            setSelectedStudent(studentNum);
                            setShowTimeModal(true);
                            return prev;
                        case 'late': next = 'absent'; break;
                        case 'absent': next = 'unchecked'; break;
                        default: next = 'unchecked';
                    }
                    
                    return { ...prev, [studentNum]: next };
                });
            };

            const setLateTimeForStudent = (time) => {
                if (selectedStudent && time) {
                    setAttendance(prev => ({ ...prev, [selectedStudent]: 'late' }));
                    setLateTime(prev => ({ ...prev, [selectedStudent]: time }));
                }
                setShowTimeModal(false);
                setSelectedStudent(null);
            };

            const getStatusStyle = (status) => {
                switch(status) {
                    case 'present': 
                        return {
                            bg: 'bg-green-100 border-green-300',
                            text: 'text-green-800',
                            icon: React.createElement(Check, { className: "w-5 h-5" }),
                            label: 'ì¶œì„'
                        };
                    case 'late':
                        return {
                            bg: 'bg-yellow-100 border-yellow-300',
                            text: 'text-yellow-800',
                            icon: React.createElement(Clock, { className: "w-5 h-5" }),
                            label: 'ì§€ê°'
                        };
                    case 'absent':
                        return {
                            bg: 'bg-red-100 border-red-300',
                            text: 'text-red-800',
                            icon: React.createElement(X, { className: "w-5 h-5" }),
                            label: 'ê²°ì„'
                        };
                    default:
                        return {
                            bg: 'bg-gray-100 border-gray-300',
                            text: 'text-gray-600',
                            icon: null,
                            label: 'ë¯¸ì²´í¬'
                        };
                }
            };

            const stats = {
                present: Object.values(attendance).filter(s => s === 'present').length,
                late: Object.values(attendance).filter(s => s === 'late').length,
                absent: Object.values(attendance).filter(s => s === 'absent').length,
                unchecked: Object.values(attendance).filter(s => s === 'unchecked').length
            };

            const resetAll = () => {
                const reset = initializeAttendance();
                setAttendance(reset);
                setLateTime({});
            };

            const TimeInputModal = () => {
                const [inputTime, setInputTime] = useState('');

                const handleConfirm = () => {
                    setLateTimeForStudent(inputTime.trim() || 'ì‹œê°„ë¯¸ì…ë ¥');
                    setInputTime('');
                };

                const handleCancel = () => {
                    setShowTimeModal(false);
                    setSelectedStudent(null);
                    setInputTime('');
                };

                if (!showTimeModal) return null;

                return (
                    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                        <div className="bg-white rounded-lg p-6 w-full max-w-sm">
                            <h3 className="text-lg font-semibold text-gray-800 mb-4">
                                {selectedStudent}ë²ˆ í•™ìƒ ì§€ê° ì‹œê°„ ì…ë ¥
                            </h3>
                            <div>
                                <input
                                    type="time"
                                    value={inputTime}
                                    onChange={(e) => setInputTime(e.target.value)}
                                    className="w-full p-3 border border-gray-300 rounded-lg mb-4 text-center text-lg"
                                    autoFocus
                                />
                                <div className="text-xs text-gray-500 mb-4 text-center">
                                    ì‹œê°„ì„ ì…ë ¥í•˜ì§€ ì•Šì•„ë„ ì§€ê° ì²˜ë¦¬ë©ë‹ˆë‹¤
                                </div>
                                <div className="flex gap-3">
                                    <button
                                        type="button"
                                        onClick={handleCancel}
                                        className="flex-1 px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors"
                                    >
                                        ì·¨ì†Œ
                                    </button>
                                    <button
                                        type="button"
                                        onClick={handleConfirm}
                                        className="flex-1 px-4 py-2 bg-yellow-500 text-white rounded-lg hover:bg-yellow-600 transition-colors"
                                    >
                                        í™•ì¸
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            };

            return (
                <div className="min-h-screen bg-blue-50 p-4">
                    <div className="max-w-4xl mx-auto">
                        {/* í—¤ë” */}
                        <div className="bg-white rounded-lg shadow-md p-6 mb-6">
                            <div className="flex items-center justify-between mb-2">
                                <h1 className="text-2xl font-bold text-gray-800">ì¶œì„ ì²´í¬</h1>
                                <div className="flex items-center">
                                    {isOnline ? 
                                        React.createElement(Wifi, { className: "w-5 h-5 text-green-600" }) :
                                        React.createElement(WifiOff, { className: "w-5 h-5 text-red-600" })
                                    }
                                </div>
                            </div>
                            <p className="text-gray-600">{currentDate}</p>
                            
                            {/* í†µê³„ */}
                            <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mt-4">
                                <div className="bg-green-50 p-3 rounded-lg text-center">
                                    <div className="text-lg font-bold text-green-800">{stats.present}</div>
                                    <div className="text-sm text-green-600">ì¶œì„</div>
                                </div>
                                <div className="bg-yellow-50 p-3 rounded-lg text-center">
                                    <div className="text-lg font-bold text-yellow-800">{stats.late}</div>
                                    <div className="text-sm text-yellow-600">ì§€ê°</div>
                                </div>
                                <div className="bg-red-50 p-3 rounded-lg text-center">
                                    <div className="text-lg font-bold text-red-800">{stats.absent}</div>
                                    <div className="text-sm text-red-600">ê²°ì„</div>
                                </div>
                                <div className="bg-gray-50 p-3 rounded-lg text-center">
                                    <div className="text-lg font-bold text-gray-800">{stats.unchecked}</div>
                                    <div className="text-sm text-gray-600">ë¯¸ì²´í¬</div>
                                </div>
                            </div>
                            
                            {/* ì´ˆê¸°í™” ë²„íŠ¼ */}
                            <button
                                onClick={resetAll}
                                className="mt-4 px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors w-full md:w-auto"
                            >
                                ì „ì²´ ì´ˆê¸°í™”
                            </button>
                        </div>

                        {/* ì¶œì„ë¶€ */}
                        <div className="bg-white rounded-lg shadow-md p-6">
                            <h2 className="text-xl font-semibold text-gray-800 mb-4">í•™ìƒ ëª…ë‹¨ (ì´ 24ëª…)</h2>
                            
                            {/* ì‚¬ìš©ë²• ì•ˆë‚´ */}
                            <div className="bg-blue-50 p-3 rounded-lg mb-4 text-sm text-blue-800">
                                ğŸ’¡ í•™ìƒ ë²ˆí˜¸ë¥¼ í„°ì¹˜í•˜ì—¬ ì¶œì„ ìƒíƒœë¥¼ ë³€ê²½í•˜ì„¸ìš”: ë¯¸ì²´í¬ â†’ ì¶œì„ â†’ ì§€ê°(ì‹œê°„ì…ë ¥) â†’ ê²°ì„ â†’ ë¯¸ì²´í¬
                            </div>
                            
                            {/* í•™ìƒ ëª©ë¡ */}
                            <div className="student-grid grid gap-3">
                                {studentNumbers.map(num => {
                                    const status = getStatusStyle(attendance[num]);
                                    const studentLateTime = lateTime[num] || '';
                                    
                                    return (
                                        <button
                                            key={num}
                                            onClick={() => toggleAttendance(num)}
                                            className={`${status.bg} ${status.text} border-2 ${status.bg.replace('bg-', 'border-').replace('-100', '-300')} 
                                                rounded-lg p-4 hover:opacity-80 transition-all duration-200 transform active:scale-95 touch-manipulation`}
                                        >
                                            <div className="text-lg font-bold mb-1">{num}ë²ˆ</div>
                                            <div className="flex items-center justify-center mb-1">
                                                {status.icon}
                                            </div>
                                            <div className="text-xs">{status.label}</div>
                                            {attendance[num] === 'late' && studentLateTime && (
                                                <div className="text-xs font-semibold mt-1 text-yellow-900">
                                                    {studentLateTime}
                                                </div>
                                            )}
                                        </button>
                                    );
                                })}
                            </div>
                        </div>

                        <TimeInputModal />

                        {/* ë²”ë¡€ */}
                        <div className="bg-white rounded-lg shadow-md p-4 mt-4">
                            <h3 className="text-lg font-semibold text-gray-800 mb-3">ìƒíƒœ ë²”ë¡€</h3>
                            <div className="grid grid-cols-2 md:flex md:flex-wrap gap-4">
                                <div className="flex items-center gap-2">
                                    <div className="w-4 h-4 bg-green-100 border border-green-300 rounded"></div>
                                    <span className="text-sm">ì¶œì„</span>
                                </div>
                                <div className="flex items-center gap-2">
                                    <div className="w-4 h-4 bg-yellow-100 border border-yellow-300 rounded"></div>
                                    <span className="text-sm">ì§€ê°</span>
                                </div>
                                <div className="flex items-center gap-2">
                                    <div className="w-4 h-4 bg-red-100 border border-red-300 rounded"></div>
                                    <span className="text-sm">ê²°ì„</span>
                                </div>
                                <div className="flex items-center gap-2">
                                    <div className="w-4 h-4 bg-gray-100 border border-gray-300 rounded"></div>
                                    <span className="text-sm">ë¯¸ì²´í¬</span>
                                </div>
                            </div>
                        </div>

                        {/* PWA ì •ë³´ */}
                        <div className="bg-white rounded-lg shadow-md p-4 mt-4">
                            <h3 className="text-lg font-semibold text-gray-800 mb-2">ğŸ“± ì•±ìœ¼ë¡œ ì„¤ì¹˜í•˜ê¸°</h3>
                            <p className="text-sm text-gray-600 mb-2">
                                ì´ ì•±ì„ í™ˆ í™”ë©´ì— ì¶”ê°€í•˜ë©´ ë„¤ì´í‹°ë¸Œ ì•±ì²˜ëŸ¼ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                            </p>
                            <div className="text-xs text-gray-500">
                                <strong>iOS:</strong> ê³µìœ  ë²„íŠ¼ â†’ "í™ˆ í™”ë©´ì— ì¶”ê°€"<br/>
                                <strong>Android:</strong> ë©”ë‰´ â†’ "í™ˆ í™”ë©´ì— ì¶”ê°€" ë˜ëŠ” ìƒë‹¨ ì„¤ì¹˜ ì•Œë¦¼ í™•ì¸
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // PWA ê¸°ëŠ¥
        let deferredPrompt;

        // PWA ì„¤ì¹˜ í”„ë¡¬í”„íŠ¸ ì²˜ë¦¬
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            document.getElementById('install-prompt').style.display = 'block';
        });

        // ì„¤ì¹˜ ë²„íŠ¼ í´ë¦­
        document.getElementById('install-btn').addEventListener('click', async () => {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                deferredPrompt = null;
                document.getElementById('install-prompt').style.display = 'none';
            }
        });

        // ë‚˜ì¤‘ì— ë²„íŠ¼ í´ë¦­
        document.getElementById('dismiss-btn').addEventListener('click', () => {
            document.getElementById('install-prompt').style.display = 'none';
        });

        // ì„œë¹„ìŠ¤ ì›Œì»¤ ë“±ë¡
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                const swScript = `
                    const CACHE_NAME = 'attendance-v1';
                    const urlsToCache = [
                        '/',
                        'https://cdn.tailwindcss.com',
                        'https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.development.js',
                        'https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.development.js',
                        'https://unpkg.com/@babel/standalone/babel.min.js',
                        'https://unpkg.com/lucide@latest/dist/umd/lucide.js'
                    ];

                    self.addEventListener('install', (event) => {
                        event.waitUntil(
                            caches.open(CACHE_NAME)
                                .then((cache) => cache.addAll(urlsToCache))
                        );
                    });

                    self.addEventListener('fetch', (event) => {
                        event.respondWith(
                            caches.match(event.request)
                                .then((response) => {
                                    if (response) {
                                        return response;
                                    }
                                    return fetch(event.request);
                                })
                        );
                    });
                `;

                const blob = new Blob([swScript], { type: 'application/javascript' });
                const swUrl = URL.createObjectURL(blob);

                navigator.serviceWorker.register(swUrl)
                    .then((registration) => {
                        console.log('Service Worker ë“±ë¡ ì„±ê³µ:', registration);
                    })
                    .catch((error) => {
                        console.log('Service Worker ë“±ë¡ ì‹¤íŒ¨:', error);
                    });
            });
        }

        // React ì•± ë Œë”ë§
        ReactDOM.render(React.createElement(AttendanceChecker), document.getElementById('root'));
    </script>
</body>
</html>